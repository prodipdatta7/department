name: Beautify Bug Report
on:
  issues:
    types: [opened]

jobs:
  pretty:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Format summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue
            const body = issue.body || ""

            // naive parsing of form fields from issue body (field headings)
            const get = (label) => {
              const re = new RegExp(`\\n${label}\\n\\n([\\s\\S]*?)(\\n\\n[A-Z]|$)`)
              const m = body.match(re)
              return m ? m[1].trim() : ''
            }

            const priority = get('Priority') || ''
            const environment = get('Environment') || ''
            const module = get('Module') || 'None'
            const assigneePref = get('Preferred assignee') || 'Unassigned'

            // Map to labels + shield colors
            const priMap = { 'üî¥ HIGH':'high','üü† MEDIUM':'medium','üü¢ LOW':'low' }
            const envMap = { 'üî¥ PRODUCTION':'production','üü° STAGE':'stage','‚ö™ DEV':'dev' }

            const priKey = Object.keys(priMap).find(k => priority.includes(k)) || ''
            const envKey = Object.keys(envMap).find(k => environment.includes(k)) || ''

            const priLabel = priKey ? `priority: ${priMap[priKey]}` : null
            const envLabel = envKey ? `env: ${envMap[envKey]}` : null

            // Create shields (colors are examples)
            const priBadge = priKey
              ? `!priority}-${priMap[priKey]==='high'?'d0021b':priMap[priKey]==='medium'?'f5a623':'2ecc71'})`
              : ''
            const envBadge = envKey
              ? `!environment}-${envMap[envKey]==='production'?'d0021b':envMap[envKey]==='stage'?'f4d03f':'8e8e93'})`
              : ''

            // Build fancy comment
            const title = issue.title.replace(/\\[Bug\\]:\\s*/, '')
            const comment = `
            ## üêû ${title}

            ${priBadge} ${envBadge}

            **Module:** ${module}  
            **Preferred assignee:** ${assigneePref}

            <details><summary><b>Bug description</b></summary>

            ${get('Bug description')}

            </details>

            <details><summary><b>Expected behavior</b></summary>

            ${get('Expected behavior')}

            </details>

            <details><summary><b>Steps to reproduce</b></summary>

            ${get('Steps to reproduce (if needed)') || '_No response_'}

            </details>

            **Reporter:** ${get('Reporter') || '_No response_'}  
            **Attachments:** ${get('Links to media/logs (optional)') || '_No response_'}  
            **Additional info:** ${get('Additional supporting info (optional)') || '_No response_'}
            `

            // Post comment
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issue.number,
              body: comment
            })

            // Apply labels
            const labelsToAdd = [priLabel, envLabel].filter(Boolean)
            if (labelsToAdd.length) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              })
            }
