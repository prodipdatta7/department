name: Beautify Bug Report
on:
  issues:
    types: [opened]

jobs:
  pretty:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Always comment (baseline)
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issue.number,
              body: `âœ… Workflow running for **#${issue.number}**: "${issue.title}"`
            });

      - name: Parse and beautify
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";

            const esc = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const section = (label) => {
              const re = new RegExp(`(^|\\n)###\\s+${esc(label)}\\s*\\n([\\s\\S]*?)(?=\\n###\\s|$)`);
              const m = body.match(re);
              return m ? m[2].trim() : '';
            };

            const priText = section('Priority (*)') || section('Priority');
            const envText = section('Environment (*)') || section('Environment');
            const moduleText = section('Module');
            const assigneeText = section('Assignee') || section('Preferred assignee');

            const parseLines = (t) => t.split('\n').map(s => s.trim()).filter(Boolean);
            const parseCheckboxSelected = (t) => [...t.matchAll(/-\s\[[xX]\]\s(.+)/g)].map(m => m[1].trim());

            const priority = parseLines(priText)[0] || '_None_';
            const envSelected = parseCheckboxSelected(envText);
            const modulesSelected = parseLines(moduleText);
            const assigneesSelected = parseLines(assigneeText);

            const comment = `
            ### ðŸ§¾ Summary
            - **Priority:** ${priority}
            - **Environment:** ${envSelected.join(', ') || '_None_'}
            - **Modules:** ${modulesSelected.join(', ') || '_None_'}
            - **Assignees:** ${assigneesSelected.join(', ') || '_None_'}
            `;

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: issue.number,
              body: comment
            });
